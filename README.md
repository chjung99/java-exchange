# **🪙 BTC 거래소 매수/매도 시스템 구현**

## 📚 학습 목표
- 객체 지향적 설계 기반으로 **클래스 역할 분리, 협력 구조 설계** 경험
- **멀티스레딩 환경**에서 동시성 문제 해결 및 거래 정합성 유지
- 단위 테스트 및 멀티스레드 테스트로 신뢰성 있는 트레이딩 로직 검증
- 입력 검증, 예외 처리, 단일 책임 원칙(SRP) 준수 및 UI 로직 분리

---

## 🚀 미션 개요
- 사용자는 **BTC를 MARKET 매수**하거나 **SELL 지정가 주문** 가능
- 여러 사용자가 동시에 주문하더라도 **잔고 및 체결 정합성** 유지
- 부분 체결, 멀티스레드 환경 처리, 체결 가격 결정 포함

---

## 📌 핵심 시나리오
1. 프로그램 시작 시 사용자별 **KRW 및 BTC 잔고** 입력
2. 사용자는 MARKET 매수 / SELL 지정가 주문 입력
3. 거래소는 **OrderBook에서 매칭 가능한 주문과 체결**
4. 체결 성공 시 **KRW 잔고 차감/증가, BTC 잔고 증가/차감**
5. **부분 체결 가능**: 주문 수량이 상대 주문 수량보다 많으면 일부 체결
6. 프로그램 종료 시 **전체 주문 내역과 최종 잔고 출력**

---

## 📝 요구 사항

### 1️⃣ 사용자 잔고 초기화
- 콘솔 또는 테스트 객체에서 입력
- KRW 잔고, BTC 잔고 입력
- 0 미만 또는 숫자가 아닌 입력 → `[ERROR] 잘못된 입력입니다.` 출력 후 재입력

**예시 입력**

```
사용자 ID: U001
보유 KRW: 100000000
보유 BTC: 0
사용자 ID: U002
보유 KRW: 50000000
보유 BTC: 1
사용자 ID: U003
보유 KRW: 70000000
보유 BTC: 0
END
```

---

### 2️⃣ 주문 입력 형식

<사용자ID>,<가격>,<수량>,<BUY/SELL>,

**설명**

| 항목 | 설명 | 비고 |
|---|---|---|
| 사용자ID | 주문자 식별자 | 영문+숫자 |
| 가격 | SELL 주문 시 BTC 1개당 가격 (원) | BUY(MARKET)는 0 |
| 수량 | 매수/매도 수량 | 소수점 허용 |
| BUY/SELL | 매수/매도 구분 | BUY = MARKET 매수, SELL = 지정가 매도 |
| TimeStamp | 주문 시간 | ISO 8601 형식, 체결 우선순위 기준 |

**예시**

```
U001,100000000,1,SELL,2025-11-23T16:50:00
U002,0,0.5,BUY,2025-11-23T16:51:05
U003,0,0.7,BUY,2025-11-23T16:52:00
END
```

- 입력 종료: `END`

---

### 3️⃣ 주문 처리
- **BUY 주문**: MARKET 주문 → OrderBook 최적 SELL 가격으로 즉시 체결
- **SELL 주문**: 지정가 → OrderBook에 등록, 매칭 가능 시 즉시 체결
- **부분 체결 가능**: 주문 수량 > 상대 주문 수량 → 일부 체결, 잔량은 OrderBook 대기
- **체결 우선순위**: 가격 우선 → 시간 순

---

### 4️⃣ 체결 후 처리
1. KRW 잔고 차감/증가: 체결 가격 × 체결 수량
2. BTC 잔고 증가/차감: 체결 수량만큼
3. 체결 내역 기록: Trade 객체 또는 Map/List 자유 구현
4. 잔고 부족 → `[ERROR] 잔고가 부족합니다.` 출력

---

### 5️⃣ 멀티스레드 환경
- 여러 스레드에서 주문 처리 가능
- **Race Condition 방지 필수**: Wallet, OrderBook 접근 시 동기화
- `synchronized`, `ReentrantLock`, `Atomic`, `Concurrent 자료구조` 자유 선택

---

### 6️⃣ 예외 처리
- 잘못된 입력 → `[ERROR] 잘못된 입력 형식입니다.`
- 잔고 부족 → `[ERROR] 잔고가 부족합니다.`
- 체결 불가 → `[ERROR] 체결 가능한 주문이 없습니다.`

---

## 💻 입출력 예시

### 사용자 잔고 입력

```
사용자 잔고를 입력해 주세요.

사용자 ID: U001
보유 KRW: 100000000
보유 BTC: 0
사용자 ID: U002
보유 KRW: 50000000
보유 BTC: 1
사용자 ID: U003
보유 KRW: 70000000
보유 BTC: 0
END
```

### 주문 입력

```
체결할 주문을 입력해 주세요.

U001,100000000,1,SELL,2025-11-23T16:50:00
U002,0,0.5,BUY,2025-11-23T16:51:05
U003,0,0.7,BUY,2025-11-23T16:52:00
END
```

### 체결 출력 (부분 체결 반영)

```
2개의 주문이 체결되었습니다.

[ORDER EXECUTED] U002 BTC 100000000 0.5
[ORDER EXECUTED] U003 BTC 100000000 0.5
```

### 최종 잔고 출력

```
[FINAL BALANCE]

U001 - KRW: 150000000, BTC: 0
U002 - KRW: 0, BTC: 0.5
U003 - KRW: 20000000, BTC: 0.5
```

---

## 🧪 테스트 요구 사항
| 테스트 항목 | 설명 |
|---|---|
| 단일 SELL 주문, MARKET 매수 | 정상 체결 확인 |
| 부분 체결 | SELL 수량 < BUY 요청 수량 시 일부만 체결 |
| 멀티스레드 동시 주문 | Race Condition 방지 확인 |
| 잔고 부족 | 예외 발생 확인 |
| OrderBook 관리 | 등록, 체결, 잔량 확인 |

---

## 👨‍💻 프로그래밍 요구 사항
- Java 21, Application.main() 시작
- UI 로직(System.in/out)은 테스트 대상 제외
- indent depth ≤ 2, 메서드 길이 ≤ 15줄
- `else`, `switch-case` 금지
- Enum 활용
- 단일 책임 원칙(SRP) 준수
- 단위 테스트(JUnit5, AssertJ) 필수

---

## 📌 구현 힌트
- **OrderBook**: PriorityQueue, TreeMap 등 사용 가능
- **Wallet**: 사용자 잔고 관리, 동기화 필수
- **Trade**: 체결 내역 저장 구조 설계
- 부분 체결 및 동시성 처리 명확히 테스트

---

# 기능 목록

# 1️⃣ 사용자 잔고 관리
- [ ] 사용자 등록 및 초기 잔고 입력 (KRW, BTC)
- [ ] 입력값 검증: 음수 또는 숫자가 아닌 경우 예외 처리
- [ ] Wallet 클래스/객체로 KRW/코인 잔고 관리
- [ ] 멀티스레드 환경에서도 잔고 일관성 유지

# 2️⃣ 주문 생성
- [ ] 주문 입력 파싱: <사용자ID>,BTC,주문유형,가격,수량
- [ ] 주문 유형 ENUM 적용: LIMIT / MARKET
- [ ] 주문 입력값 검증: 사용자ID, 가격, 수량
- [ ] 잘못된 입력 시 "[ERROR] 잘못된 입력 형식입니다." 출력 후 재입력

# 3️⃣ OrderBook 관리
- [ ] OrderBook 객체 설계
- [ ] LIMIT 주문 등록: 체결 가능 시 즉시 체결, 불가 시 OrderBook 대기
- [ ] MARKET 주문 처리: OrderBook 최적 가격으로 즉시 체결
- [ ] 부분 체결 지원: 주문 수량 > 매칭 가능한 판매량
- [ ] 체결 순서: 가격 우선 → 시간 우선
- [ ] 멀티스레드 환경에서 안전하게 접근 (동기화 적용)

# 4️⃣ 체결 처리 (TradeEngine)
- [ ] 주문 매칭 로직 구현
- [ ] 체결 시 Wallet 업데이트: KRW 차감, BTC 증가
- [ ] 체결 기록 저장: Trade 객체 또는 Map/List
- [ ] 잔고 부족 시 "[ERROR] 잔고가 부족합니다." 출력

# 5️⃣ 출력 기능
- [ ] 체결 시 콘솔 출력: [ORDER EXECUTED] 사용자 코인 체결가 수량
- [ ] 프로그램 종료 후 최종 잔고 출력: [FINAL BALANCE] 사용자 - KRW, BTC
- [ ] 예외 메시지 출력

# 6️⃣ 멀티스레드 환경 처리
- [ ] 여러 스레드에서 동시에 주문 요청 가능
- [ ] Wallet과 OrderBook 접근 시 동기화 적용
- [ ] 부분 체결 및 Race Condition 방지

# 7️⃣ 테스트 코드
- [ ] 단일 사용자 LIMIT 주문 정상 체결 확인
- [ ] MARKET 주문 정상 체결 확인
- [ ] 부분 체결 동작 확인
- [ ] 멀티스레드 동시 주문 테스트
- [ ] 잔고 부족 예외 처리 테스트
- [ ] OrderBook 등록/체결/잔량 확인 테스트